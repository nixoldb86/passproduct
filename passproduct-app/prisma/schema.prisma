generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum ProductCondition {
  NEW
  LIKE_NEW
  VERY_GOOD
  GOOD
  ACCEPTABLE
}

enum ListingStatus {
  DRAFT
  PUBLISHED
  RESERVED
  SOLD
  CANCELLED
}

enum VerificationLevel {
  LEVEL_0  // photos + condition
  LEVEL_1  // + ticket/proof of purchase
  LEVEL_2  // + identifier (IMEI/serial) + extra checks
}

enum OrderStatus {
  CREATED
  PAID
  ESCROW_HOLD
  SHIPPED
  HANDED_OVER
  DELIVERED
  ACCEPTED
  RELEASED
  DISPUTED
  REFUNDED
}

enum DisputeReason {
  NOT_RECEIVED
  NOT_AS_DESCRIBED
  NOT_WORKING
}

enum DisputeStatus {
  OPENED
  UNDER_REVIEW
  RESOLVED
}

enum DisputeOutcome {
  RELEASE
  REFUND
  RETURN
}

// ==========================================
// CORE ENTITIES
// ==========================================

model User {
  id              String    @id @default(cuid())
  clerkId         String    @unique
  email           String    @unique
  firstName       String?
  lastName        String?
  avatarUrl       String?
  country         String    @default("ES")
  language        String    @default("es")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  products        Product[]
  listings        Listing[]
  buyerOrders     Order[]   @relation("BuyerOrders")
  sellerOrders    Order[]   @relation("SellerOrders")
  buyerConversations   Conversation[] @relation("BuyerConversations")
  sellerConversations  Conversation[] @relation("SellerConversations")
  messages        Message[]
  disputes        Dispute[]

  @@index([clerkId])
  @@index([email])
}

model Category {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  icon            String?
  parentId        String?
  parent          Category? @relation("CategoryChildren", fields: [parentId], references: [id])
  children        Category[] @relation("CategoryChildren")
  
  // Dynamic attributes schema (JSON)
  attributeSchema Json?     // Defines required/optional attributes per category
  
  // Verification policies
  minPhotos       Int       @default(2)
  requiresTicket  Boolean   @default(false)
  requiresSerial  Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  products        Product[]
  listings        Listing[]

  @@index([slug])
  @@index([parentId])
}

model Product {
  id                    String            @id @default(cuid())
  userId                String
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  categoryId            String
  category              Category          @relation(fields: [categoryId], references: [id])
  
  // Basic info
  brand                 String
  model                 String
  variant               String?           // e.g., "256GB Space Gray"
  condition             ProductCondition
  
  // Purchase info (optional)
  purchaseDate          DateTime?
  purchasePrice         Decimal?          @db.Decimal(10, 2)
  purchaseStore         String?
  
  // Proof & warranty
  proofOfPurchaseUrl    String?           // Ticket/invoice image
  warrantyEndDate       DateTime?
  
  // Identifiers (NEVER store in plain text)
  imeiHash              String?           // Hashed IMEI
  imeiLast4             String?           // Last 4 digits for display
  serialHash            String?           // Hashed serial
  serialLast4           String?           // Last 4 digits for display
  
  // Media
  photos                String[]          // Array of URLs
  
  // Accessories & extras (JSON)
  accessories           Json?             // { "charger": true, "box": true, "earphones": false }
  
  // Dynamic attributes (JSON) - varies by category
  attributes            Json?             // e.g., { "storage": "256GB", "color": "Black" }
  
  // Value estimation (cached)
  estimatedValue        Decimal?          @db.Decimal(10, 2)
  estimatedValueUpdatedAt DateTime?
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  listings              Listing[]

  @@index([userId])
  @@index([categoryId])
  @@index([brand, model])
}

model Listing {
  id                    String            @id @default(cuid())
  
  // Can be linked to a wallet product (or standalone for future)
  productId             String?
  product               Product?          @relation(fields: [productId], references: [id])
  
  sellerId              String
  seller                User              @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  
  categoryId            String
  category              Category          @relation(fields: [categoryId], references: [id])
  
  // Listing info
  title                 String
  description           String            @db.Text
  price                 Decimal           @db.Decimal(10, 2)
  
  // Location & shipping
  location              String?           // City/region
  latitude              Decimal?          @db.Decimal(10, 8)
  longitude             Decimal?          @db.Decimal(11, 8)
  shippingEnabled       Boolean           @default(false)
  shippingCost          Decimal?          @db.Decimal(10, 2)
  
  // Verification
  verificationLevel     VerificationLevel @default(LEVEL_0)
  
  // Badges (computed but cached for performance)
  hasVerifiedPurchase   Boolean           @default(false)
  hasValidWarranty      Boolean           @default(false)
  hasVerifiedAccessories Boolean          @default(false)
  hasVerifiedIdentifier Boolean           @default(false)
  
  // Status
  status                ListingStatus     @default(DRAFT)
  
  // Media (can be different from product photos)
  photos                String[]
  
  // Boost/promotion
  isBoosted             Boolean           @default(false)
  boostedUntil          DateTime?
  
  // Stats
  viewCount             Int               @default(0)
  favoriteCount         Int               @default(0)
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  publishedAt           DateTime?
  soldAt                DateTime?

  // Relations
  conversations         Conversation[]
  orders                Order[]

  @@index([sellerId])
  @@index([categoryId])
  @@index([status])
  @@index([price])
  @@index([location])
  @@index([createdAt])
}

model Conversation {
  id              String    @id @default(cuid())
  
  listingId       String
  listing         Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  buyerId         String
  buyer           User      @relation("BuyerConversations", fields: [buyerId], references: [id], onDelete: Cascade)
  
  sellerId        String
  seller          User      @relation("SellerConversations", fields: [sellerId], references: [id], onDelete: Cascade)
  
  // Offer tracking
  currentOffer    Decimal?  @db.Decimal(10, 2)
  offerStatus     String?   // "pending", "accepted", "rejected"
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  messages        Message[]

  @@unique([listingId, buyerId])
  @@index([buyerId])
  @@index([sellerId])
}

model Message {
  id              String    @id @default(cuid())
  
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  senderId        String
  sender          User      @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  text            String    @db.Text
  
  // Special message types
  isOffer         Boolean   @default(false)
  offerAmount     Decimal?  @db.Decimal(10, 2)
  
  isSystemMessage Boolean   @default(false)
  
  readAt          DateTime?
  
  createdAt       DateTime  @default(now())

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model Order {
  id              String      @id @default(cuid())
  
  listingId       String
  listing         Listing     @relation(fields: [listingId], references: [id])
  
  buyerId         String
  buyer           User        @relation("BuyerOrders", fields: [buyerId], references: [id])
  
  sellerId        String
  seller          User        @relation("SellerOrders", fields: [sellerId], references: [id])
  
  // Pricing
  amount          Decimal     @db.Decimal(10, 2)  // Item price
  shippingAmount  Decimal     @db.Decimal(10, 2)  @default(0)
  feeMarketplace  Decimal     @db.Decimal(10, 2)  // 6-8%
  feeProtection   Decimal     @db.Decimal(10, 2)  // 1-2.5% with cap
  total           Decimal     @db.Decimal(10, 2)  // Total buyer pays
  
  // Seller receives (after fees)
  sellerPayout    Decimal     @db.Decimal(10, 2)
  
  // Status
  status          OrderStatus @default(CREATED)
  
  // Shipping/handover info
  trackingNumber  String?
  carrier         String?
  isLocalPickup   Boolean     @default(false)
  
  // Timestamps for timeline
  paidAt          DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  acceptedAt      DateTime?
  releasedAt      DateTime?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  disputes        Dispute[]

  @@index([buyerId])
  @@index([sellerId])
  @@index([listingId])
  @@index([status])
}

model Dispute {
  id              String          @id @default(cuid())
  
  orderId         String
  order           Order           @relation(fields: [orderId], references: [id])
  
  openedById      String
  openedBy        User            @relation(fields: [openedById], references: [id])
  
  reason          DisputeReason
  description     String          @db.Text
  evidenceUrls    String[]
  
  status          DisputeStatus   @default(OPENED)
  outcome         DisputeOutcome?
  
  // Admin notes (internal)
  adminNotes      String?         @db.Text
  resolvedAt      DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([orderId])
  @@index([openedById])
  @@index([status])
}

// ==========================================
// PRICING & VALUATION
// ==========================================

model PriceHistory {
  id              String    @id @default(cuid())
  
  brand           String
  model           String
  variant         String?
  condition       ProductCondition
  
  // Price data
  minPrice        Decimal   @db.Decimal(10, 2)
  avgPrice        Decimal   @db.Decimal(10, 2)
  maxPrice        Decimal   @db.Decimal(10, 2)
  
  // Source & date
  source          String?   // e.g., "internal", "scraper", etc.
  recordedAt      DateTime  @default(now())

  @@index([brand, model, variant])
  @@index([recordedAt])
}

// ==========================================
// ALERTS & NOTIFICATIONS
// ==========================================

model Alert {
  id              String    @id @default(cuid())
  userId          String
  productId       String?
  
  type            String    // "price_drop", "sell_now", "warranty_expiring"
  title           String
  message         String
  
  isRead          Boolean   @default(false)
  
  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([isRead])
}
